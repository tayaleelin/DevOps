name: Deploy AKS
run-name: ${{ github.actor }} AKS Deployment

on: [push]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout TayaleeLin/DevOps
        uses: actions/checkout@v3
      - name: Checkout Azure/ResourceModules
        uses: actions/checkout@v3
        with:
          repository: Azure/ResourceModules
          path: ResourceModules
      - name: Create Resource Group
        uses: azure/CLI@v1
        with:
          azcliversion: 2.29.0
          inlineScript: |
            az login --service-principal -u ${{ secrets.AZURE_CLIENT_ID }} -p ${{ secrets.AZURE_CLIENT_SECRET }} --tenant ${{ secrets.AZURE_TENANT_ID }}
            az account set --subscription ${{ secrets.AZURE_SUBSCRIPTION_ID }}
            az group create --name ${{ secrets.AZURE_RESOURCE_GROUP }} --location ${{ secrets.AZURE_LOCATION }}

            primaryAgentPoolProfile="{\"count\": 1, \"vmSize\": \"Standard_D2s_v3\", \"osType\": \"Linux\", \"osDiskSizeGB\": 30, \"type\": \"VirtualMachineScaleSets\", \"name\": \"primaryaks\", \"mode\": \"System\", \"enableAutoScaling\": true, \"minCount\": 1, \"maxCount\": 1, \"maxPods\": 100, \"nodeLabels\": {\"nodepool-type\": \"primary\"}}"
            echo $primaryAgentPoolProfile
          # az deployment group create --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} \
          # --template-file ResourceModules/modules/container-service/managed-clusters/main.bicep \
          # --parameters name=${{ secrets.AZURE_AKS_CLUSTER_NAME }} primaryAgentPoolProfile="$primaryAgentPoolProfile"
      # - name: Set context to AKS
      #   uses: azure/aks-set-context@v1
      #   with:
      #     creds: ${{ secrets.AZURE_CREDENTIALS }}
      #     cluster-name: ${{ secrets.AZURE_AKS_CLUSTER_NAME }}
      #     resource-group: ${{ secrets.AZURE_RESOURCE_GROUP }}
      # - name: View Kubernetes Namespaces
      #   run: kubectl get ns
      # - name: Helm install Otomi on AKS
      #   uses: deliverybot/helm@v1
      #   with:
      #     release: otomi
      #     chart: otomi-core
      #     namespace: otomi-system
